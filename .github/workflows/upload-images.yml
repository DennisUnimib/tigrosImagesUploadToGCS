name: Upload Tigros Products Images to GCS

on:
  # Esecuzione manuale dal tab Actions
  workflow_dispatch:
    inputs:
      max_concurrent_downloads:
        description: 'Max concurrent downloads'
        required: false
        default: '10'
        type: string
      collection_name:
        description: 'Collection name (override)'
        required: false
        type: string
  
  # Esecuzione schedulata (ogni giorno alle 2:00 AM UTC)
  schedule:
    - cron: '0 2 * * *'
  
  # Esecuzione su push al branch main (opzionale)
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'tigrosImagesUploadToGCS/**'

jobs:
  upload-images:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # Timeout di 2 ore
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run image upload script
        env:
          # Tutti i parametri da GitHub Secrets
          MONGO_URI: ${{ secrets.MONGO_URI }}
          DB_NAME: ${{ secrets.DB_NAME }}
          COLLECTION_NAME: ${{ inputs.collection_name || secrets.COLLECTION_NAME }}
          BUCKET_NAME: ${{ secrets.BUCKET_NAME }}
          GCS_CREDENTIALS_JSON: ${{ secrets.GCS_CREDENTIALS_JSON }}
          
          # Performance tuning
          MAX_CONCURRENT_DOWNLOADS: ${{ inputs.max_concurrent_downloads || '10' }}
          REQUEST_TIMEOUT: '30'
          MAX_RETRIES: '3'
          RETRY_DELAY: '2'
        run: |
          python upload_images_to_gcs.py
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: upload-logs-${{ github.run_number }}
          path: upload_*.log
          retention-days: 30
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Image upload process failed. Check logs for details."
